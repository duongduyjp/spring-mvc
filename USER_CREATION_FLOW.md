# üìã T√†i Li·ªáu Lu·ªìng Ho·∫°t ƒê·ªông - Ch·ª©c NƒÉng T·∫°o User

## üéØ T·ªïng Quan

Ch·ª©c nƒÉng t·∫°o user cho ph√©p admin t·∫°o t√†i kho·∫£n m·ªõi v·ªõi ƒë·∫ßy ƒë·ªß th√¥ng tin c√° nh√¢n, role v√† avatar. H·ªá th·ªëng s·ª≠ d·ª•ng Spring MVC pattern v·ªõi JSP view engine.

---

## üîÑ Lu·ªìng Ho·∫°t ƒê·ªông Chi Ti·∫øt

### **1. B∆Ø·ªöC 1: HI·ªÇN TH·ªä FORM T·∫†O USER**

#### **1.1 Client Request**
```
GET /admin/user/create
```

#### **1.2 Server Processing**
**File:** `UserController.java`
```java
@GetMapping("/admin/user/create")
public String showCreateUserForm(Model model) {
    model.addAttribute("user", new User());           // T·∫°o empty User object
    List<Role> roles = this.roleService.getAllRoles(); // L·∫•y danh s√°ch roles
    
    // Auto-create default roles n·∫øu ch∆∞a c√≥
    if (roles.isEmpty()) {
        Role adminRole = new Role();
        adminRole.setName("ADMIN");
        this.roleService.createRole(adminRole);
        
        Role userRole = new Role();
        userRole.setName("USER");
        this.roleService.createRole(userRole);
        
        roles = this.roleService.getAllRoles();
    }
    
    model.addAttribute("roles", roles);
    return "admin/user/create";                       // Tr·∫£ v·ªÅ JSP view
}
```

#### **1.3 Database Query**
```sql
-- RoleService.getAllRoles() th·ª±c thi:
SELECT r.id, r.name FROM roles r;
```

#### **1.4 View Rendering**
**File:** `/WEB-INF/view/admin/user/create.jsp`

**JSP Engine x·ª≠ l√Ω:**
1. Load layout components (header, sidebar, footer)
2. Bind empty User object v√†o form
3. Render dropdown roles t·ª´ database
4. Generate HTML form v·ªõi Spring form tags

**HTML Output:**
```html
<form action="/admin/user/create" method="POST" enctype="multipart/form-data">
    <input type="email" name="email" />
    <input type="password" name="password" />
    <input type="text" name="fullName" />
    <input type="tel" name="phoneNumber" />
    <input type="text" name="address" />
    <select name="roleName">
        <option value="ADMIN">ADMIN</option>
        <option value="USER">USER</option>
    </select>
    <input type="file" name="avatarFile" accept="image/*" />
    <button type="submit">Create</button>
</form>
```

---

### **2. B∆Ø·ªöC 2: CLIENT SUBMIT FORM**

#### **2.1 User Action**
1. User ƒëi·ªÅn th√¥ng tin v√†o form
2. User ch·ªçn avatar file (optional)
3. User click "Create" button

#### **2.2 Browser Processing**
```
POST /admin/user/create
Content-Type: multipart/form-data

Form Data:
- email: "test@gmail.com"
- password: "123456"
- fullName: "Test User"
- phoneNumber: "0123456789"
- address: "Test Address"
- roleName: "ADMIN"
- avatarFile: [binary file data]
```

---

### **3. B∆Ø·ªöC 3: SERVER X·ª¨ L√ù REQUEST**

#### **3.1 Spring MVC Dispatcher**
1. **DispatcherServlet** nh·∫≠n request
2. **HandlerMapping** t√¨m controller method t∆∞∆°ng ·ª©ng
3. **HandlerAdapter** chu·∫©n b·ªã parameters

#### **3.2 Data Binding & Validation**
**File:** `UserController.java`

```java
@InitBinder
public void initBinder(WebDataBinder binder) {
    // Ignore avatar field ƒë·ªÉ tr√°nh conflict v·ªõi file upload
    binder.setDisallowedFields("avatar");
}
```

**Spring th·ª±c hi·ªán:**
1. **Form Data Binding:** Map form fields ‚Üí User object
   ```java
   User user = new User();
   user.setEmail("test@gmail.com");
   user.setPassword("123456");
   user.setFullName("Test User");
   user.setPhoneNumber("0123456789");
   user.setAddress("Test Address");
   // avatar field b·ªã ignore b·ªüi @InitBinder
   ```

2. **File Parameter Binding:** 
   ```java
   MultipartFile avatarFile = [file data from form]
   String roleName = "ADMIN"
   ```

3. **Validation:** Spring validate User object theo constraints
   ```java
   BindingResult bindingResult = [validation results]
   ```

#### **3.3 Controller Method Processing**
**File:** `UserController.java`

```java
@PostMapping("/admin/user/create")
public String createUser(Model model, 
                        @ModelAttribute("user") User user,
                        BindingResult bindingResult,
                        @RequestParam("roleName") String roleName,
                        @RequestParam(value = "avatarFile", required = false) MultipartFile avatarFile) {
```

**X·ª≠ l√Ω theo 4 b∆∞·ªõc:**

---

### **4. B∆Ø·ªöC 4: VALIDATION CHECK**

```java
// 1. Ki·ªÉm tra validation errors
if (bindingResult.hasErrors()) {
    List<Role> roles = this.roleService.getAllRoles();
    model.addAttribute("roles", roles);
    return "admin/user/create";  // Tr·∫£ v·ªÅ form v·ªõi errors
}
```

**N·∫øu c√≥ l·ªói:** Tr·∫£ v·ªÅ form v·ªõi th√¥ng b√°o l·ªói
**N·∫øu OK:** Ti·∫øp t·ª•c x·ª≠ l√Ω

---

### **5. B∆Ø·ªöC 5: FILE UPLOAD PROCESSING**

#### **5.1 UploadService Processing**
**File:** `UploadService.java`

```java
// 2. X·ª≠ l√Ω upload avatar b·∫±ng UploadService
try {
    String avatarFileName = this.uploadService.handleSaveAvatarFile(avatarFile);
    if (avatarFileName != null) {
        user.setAvatar(avatarFileName);
    }
} catch (RuntimeException e) {
    // X·ª≠ l√Ω l·ªói upload
}
```

#### **5.2 File Upload Logic**
**Method:** `handleSaveAvatarFile(MultipartFile avatarFile)`

1. **Validate File:**
   ```java
   if (avatarFile == null || avatarFile.isEmpty()) {
       return null;  // Kh√¥ng c√≥ file, skip
   }
   ```

2. **Create Directory:**
   ```java
   String rootPath = servletContext.getRealPath("/resources/images");
   File dir = new File(rootPath + File.separator + "avatar");
   if (!dir.exists()) {
       dir.mkdirs();  // T·∫°o th∆∞ m·ª•c n·∫øu ch∆∞a c√≥
   }
   ```

3. **Generate Unique Filename:**
   ```java
   String fileName = System.currentTimeMillis() + "-" + avatarFile.getOriginalFilename();
   // VD: "1727018456789-profile.jpg"
   ```

4. **Save File:**
   ```java
   File serverFile = new File(dir.getAbsolutePath() + File.separator + fileName);
   try (BufferedOutputStream stream = new BufferedOutputStream(
           new FileOutputStream(serverFile))) {
       stream.write(avatarFile.getBytes());
   }
   ```

5. **Return Filename:**
   ```java
   return fileName;  // Tr·∫£ v·ªÅ t√™n file ƒë·ªÉ l∆∞u v√†o database
   ```

#### **5.3 File System Result**
```
/resources/images/avatar/1727018456789-profile.jpg  [File ƒë∆∞·ª£c l∆∞u]
```

#### **5.4 User Object Update**
```java
user.setAvatar("1727018456789-profile.jpg");  // L∆∞u t√™n file v√†o User object
```

---

### **6. B∆Ø·ªöC 6: ROLE ASSIGNMENT**

#### **6.1 Role Service Processing**
```java
// 3. T√¨m v√† set Role
Role role = this.roleService.getRoleByName(roleName);
if (role != null) {
    user.setRole(role);
} else {
    // X·ª≠ l√Ω l·ªói role kh√¥ng t·ªìn t·∫°i
}
```

#### **6.2 Database Query**
**File:** `RoleRepository.java`
```sql
-- RoleService.getRoleByName("ADMIN") th·ª±c thi:
SELECT r.id, r.name FROM roles r WHERE r.name = 'ADMIN';
```

#### **6.3 User Object Update**
```java
User user = {
    email: "test@gmail.com",
    password: "123456",
    fullName: "Test User",
    phoneNumber: "0123456789", 
    address: "Test Address",
    avatar: "1727018456789-profile.jpg",
    role: Role{id=7, name='ADMIN'}  // ‚Üê Role ƒë∆∞·ª£c set
}
```

---

### **7. B∆Ø·ªöC 7: DATABASE SAVE**

#### **7.1 UserService Processing**
```java
// 4. L∆∞u user
try {
    this.userService.handleCreateUser(user);
    return "redirect:/admin/user?success=true&message=User created successfully";
} catch (Exception e) {
    // X·ª≠ l√Ω l·ªói database
}
```

#### **7.2 UserService Method**
**File:** `UserService.java`
```java
public User handleCreateUser(User user) {
    return this.userRepository.save(user);  // JPA save
}
```

#### **7.3 Database Transaction**
**Hibernate th·ª±c thi SQL:**
```sql
INSERT INTO users (
    email, password, full_name, phone_number, 
    address, avatar, role_id
) VALUES (
    'test@gmail.com', '123456', 'Test User', '0123456789',
    'Test Address', '1727018456789-profile.jpg', 7
);
```

#### **7.4 Database Result**
```sql
-- User record ƒë∆∞·ª£c t·∫°o:
id | email           | password | full_name | phone_number | address      | avatar                    | role_id
10 | test@gmail.com  | 123456   | Test User | 0123456789   | Test Address | 1727018456789-profile.jpg| 7
```

---

### **8. B∆Ø·ªöC 8: RESPONSE & REDIRECT**

#### **8.1 Controller Response**
```java
return "redirect:/admin/user?success=true&message=User created successfully";
```

#### **8.2 HTTP Response**
```
HTTP/1.1 302 Found
Location: /admin/user?success=true&message=User%20created%20successfully
```

#### **8.3 Browser Redirect**
Browser t·ª± ƒë·ªông redirect ƒë·∫øn:
```
GET /admin/user?success=true&message=User%20created%20successfully
```

#### **8.4 User List Page**
**File:** `UserController.java`
```java
@GetMapping("/admin/user")
public String getUserPage(Model model) {
    List<User> users = this.userService.getAllUsers();  // L·∫•y danh s√°ch users
    model.addAttribute("users", users);
    return "admin/user/index";  // Hi·ªÉn th·ªã danh s√°ch
}
```

#### **8.5 Success Message Display**
**File:** `/WEB-INF/view/admin/user/index.jsp`
```jsp
<c:if test="${param.success == 'true'}">
    <div class="alert alert-success">
        <i class="fas fa-check-circle"></i> ${param.message}
    </div>
</c:if>
```

---

## üìä S∆° ƒê·ªì Lu·ªìng Ho·∫°t ƒê·ªông

```
[Client Browser]
       ‚Üì GET /admin/user/create
[DispatcherServlet]
       ‚Üì
[UserController.showCreateUserForm()]
       ‚Üì
[RoleService.getAllRoles()] ‚Üí [Database: SELECT roles]
       ‚Üì
[JSP Engine] ‚Üí [create.jsp] ‚Üí [HTML Form]
       ‚Üì
[Client fills form & submits]
       ‚Üì POST /admin/user/create (multipart/form-data)
[DispatcherServlet]
       ‚Üì
[Data Binding] ‚Üí [@InitBinder filters avatar field]
       ‚Üì
[UserController.createUser()]
       ‚Üì
[Validation Check] ‚Üí [BindingResult]
       ‚Üì (if valid)
[UploadService.handleSaveAvatarFile()]
       ‚Üì
[File System] ‚Üí [Save avatar file]
       ‚Üì
[RoleService.getRoleByName()] ‚Üí [Database: SELECT role]
       ‚Üì
[UserService.handleCreateUser()] ‚Üí [Database: INSERT user]
       ‚Üì
[HTTP 302 Redirect] ‚Üí [/admin/user?success=true]
       ‚Üì
[UserController.getUserPage()]
       ‚Üì
[UserService.getAllUsers()] ‚Üí [Database: SELECT users]
       ‚Üì
[JSP Engine] ‚Üí [index.jsp] ‚Üí [User List + Success Message]
       ‚Üì
[Client Browser displays result]
```

---

## üóÇÔ∏è C·∫•u Tr√∫c File Li√™n Quan

### **Backend Files:**
```
src/main/java/vn/hoidanit/laptopshop/
‚îú‚îÄ‚îÄ controller/admin/
‚îÇ   ‚îî‚îÄ‚îÄ UserController.java           # Main controller logic
‚îú‚îÄ‚îÄ service/
‚îÇ   ‚îú‚îÄ‚îÄ UserService.java             # User business logic
‚îÇ   ‚îú‚îÄ‚îÄ RoleService.java             # Role business logic
‚îÇ   ‚îî‚îÄ‚îÄ UploadService.java           # File upload logic
‚îú‚îÄ‚îÄ repository/
‚îÇ   ‚îú‚îÄ‚îÄ UserRepository.java          # User data access
‚îÇ   ‚îî‚îÄ‚îÄ RoleRepository.java          # Role data access
‚îî‚îÄ‚îÄ domain/
    ‚îú‚îÄ‚îÄ User.java                    # User entity
    ‚îî‚îÄ‚îÄ Role.java                    # Role entity
```

### **Frontend Files:**
```
src/main/webapp/
‚îú‚îÄ‚îÄ WEB-INF/view/admin/
‚îÇ   ‚îú‚îÄ‚îÄ user/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ create.jsp              # Create form
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.jsp               # User list
‚îÇ   ‚îî‚îÄ‚îÄ layout/
‚îÇ       ‚îú‚îÄ‚îÄ header.jsp              # Header component
‚îÇ       ‚îú‚îÄ‚îÄ sidebar.jsp             # Sidebar component
‚îÇ       ‚îî‚îÄ‚îÄ footer.jsp              # Footer component
‚îî‚îÄ‚îÄ resources/
    ‚îú‚îÄ‚îÄ css/main.css                # Custom styles
    ‚îî‚îÄ‚îÄ images/avatar/              # Avatar upload directory
```

### **Configuration Files:**
```
src/main/resources/
‚îú‚îÄ‚îÄ application.properties          # Database & app config
‚îî‚îÄ‚îÄ ...

src/main/java/vn/hoidanit/laptopshop/config/
‚îî‚îÄ‚îÄ WebMvcConfig.java              # MVC & resource mapping
```

---

## üîê Security & Error Handling

### **Security Measures:**
1. **File Upload Security:**
   - Accept only image files (`accept="image/*"`)
   - File size limits (50MB max)
   - Unique filename generation

2. **Data Binding Security:**
   - `@InitBinder` prevents avatar field binding conflicts
   - `@RequestParam` validation

3. **Database Security:**
   - JPA/Hibernate prevents SQL injection
   - Transaction management

### **Error Handling:**
1. **Validation Errors:** Tr·∫£ v·ªÅ form v·ªõi error messages
2. **File Upload Errors:** Hi·ªÉn th·ªã l·ªói upload
3. **Database Errors:** Catch exceptions v√† hi·ªÉn th·ªã l·ªói
4. **Role Not Found:** Hi·ªÉn th·ªã l·ªói role kh√¥ng t·ªìn t·∫°i

---

## üéØ K·∫øt Lu·∫≠n

Lu·ªìng ho·∫°t ƒë·ªông t·∫°o user ƒë∆∞·ª£c thi·∫øt k·∫ø theo Spring MVC pattern v·ªõi:
- **Separation of Concerns:** Controller, Service, Repository t√°ch bi·ªát
- **Clean Architecture:** Logic nghi·ªáp v·ª• t√°ch kh·ªèi presentation
- **Error Handling:** X·ª≠ l√Ω l·ªói to√†n di·ªán
- **Security:** B·∫£o m·∫≠t file upload v√† data binding
- **User Experience:** Form validation v√† success messages

H·ªá th·ªëng ƒë·∫£m b·∫£o t√≠nh nh·∫•t qu√°n d·ªØ li·ªáu, b·∫£o m·∫≠t v√† tr·∫£i nghi·ªám ng∆∞·ªùi d√πng t·ªët.
